#include <stdio.h>              /* Standard input/output operations */
#include <string.h>             /* String manipulation functions */
#include "driver/i2c.h"
#include "ssd1306.h"            /* SSD1306 OLED display functions */
#include "I2C.h"
#include "esp_log.h"

#define OLED_TAG  "OLED Display:"
#define BAT_TAG  "MAX17043:"

/**
 * @brief CBI Energy logo (128 x 32) in hex for use on an 128 x 32 oled I2C display
 */
uint8_t cbi_logo[] = {
	0x1f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x10, 0x60, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x30, 0x20, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x20, 0x30, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x20, 0x10, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x23, 0x11, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x63, 0x13, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x63, 0x13, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xe3, 0x13, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xe3, 0x13, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xe3, 0x13, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xe3, 0xf1, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xe3, 0xe0, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 
	0xe3, 0xf0, 0x21, 0x00, 0xff, 0xf8, 0x30, 0x01, 0xff, 0xff, 0x9f, 0xff, 0x3f, 0xfe, 0x0c, 0x03, 
	0xe3, 0x33, 0x11, 0x01, 0xff, 0xfc, 0x78, 0x01, 0xff, 0xff, 0x9f, 0xff, 0x7f, 0xff, 0x7e, 0x03, 
	0xe3, 0x13, 0x11, 0x03, 0xff, 0xfc, 0x7e, 0x03, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xfe, 0x03, 
	0xe3, 0x13, 0x11, 0x03, 0x80, 0x0c, 0x6f, 0x03, 0x70, 0x01, 0xf8, 0x00, 0xe0, 0x03, 0xec, 0x03, 
	0xe3, 0x13, 0x11, 0x13, 0x00, 0x0c, 0xe7, 0xc7, 0x70, 0x01, 0xf0, 0x00, 0xc0, 0x03, 0xec, 0x03, 
	0xe3, 0x13, 0x11, 0x3b, 0x00, 0x0c, 0xc1, 0xe7, 0x70, 0x01, 0xf0, 0x00, 0xc0, 0x03, 0xe0, 0x03, 
	0xe3, 0x13, 0x11, 0x13, 0x7f, 0xfd, 0xd8, 0xf6, 0x7f, 0xff, 0xf0, 0x00, 0xc0, 0x03, 0xe0, 0x03, 
	0xe3, 0x13, 0x11, 0x03, 0x7f, 0xfd, 0xdc, 0x6e, 0x7f, 0xff, 0xb0, 0x00, 0xc0, 0x03, 0xe0, 0x03, 
	0xe3, 0x13, 0x11, 0x13, 0x00, 0x01, 0x9f, 0x0c, 0x70, 0x00, 0x30, 0x00, 0xc0, 0x03, 0xe0, 0x03, 
	0xe0, 0x10, 0x11, 0x3b, 0x00, 0x03, 0x87, 0x8c, 0x70, 0x00, 0x30, 0x00, 0xc0, 0x03, 0xe0, 0x03, 
	0xe0, 0x30, 0x11, 0x13, 0x00, 0x03, 0x83, 0xdc, 0x70, 0x00, 0x30, 0x00, 0xe0, 0x03, 0xe0, 0x03, 
	0xf0, 0x60, 0x31, 0x03, 0xff, 0xf7, 0x00, 0xf8, 0x7f, 0xff, 0xb0, 0x00, 0xff, 0xfb, 0x7f, 0xff, 
	0xf0, 0x60, 0x31, 0x03, 0xff, 0xff, 0x00, 0x78, 0x3f, 0xff, 0xb0, 0x00, 0x7f, 0xfb, 0x7f, 0xff, 
	0xff, 0xff, 0xff, 0x01, 0xff, 0xee, 0x00, 0x30, 0x3f, 0xff, 0xb0, 0x00, 0x00, 0x03, 0x00, 0x03, 
	0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x03, 
	0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x7f, 0xff, 
	0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x7f, 0xff, 
	0x7f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfc, 0x3f, 0xfc, 
	0x3f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	
};

/**
 * @brief Battry Empty Icon
 */
uint8_t Batt_Charge[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

/**
 * @brief Battry Empty Icon
 */
uint8_t Batt_Empty[] = {
	0x7f, 0xff, 0x40, 0x01, 0xc0, 0x05, 0xc0, 0x05, 0xc0, 0x05, 0xc0, 0x05, 0x40, 0x01, 0x7f, 0xff
};

/**
 * @brief Battry Low Icon
 */
uint8_t Batt_Low[] = { 
	0x7f, 0xff, 0x40, 0x01, 0xc0, 0x3d, 0xc0, 0x3d, 0xc0, 0x3d, 0xc0, 0x3d, 0x40, 0x01, 0x7f, 0xff
};

/**
 * @brief Battry High Icon 
 */
uint8_t Batt_High[] = {
	0x7f, 0xff, 0x40, 0x01, 0xc3, 0xfd, 0xc3, 0xfd, 0xc3, 0xfd, 0xc3, 0xfd, 0x40, 0x01, 0x7f, 0xff
};

/**
 * @brief Battry Full Icon
 */
uint8_t Batt_Full[] = {
	0x7f, 0xff, 0x40, 0x01, 0xdf, 0xfd, 0xdf, 0xfd, 0xdf, 0xfd, 0xdf, 0xfd, 0x40, 0x01, 0x7f, 0xff
};

/**
 * @brief The display function is resposible for all the operations used  
 * 
 */	

SSD1306_t dev;
float soc_pre = 0;
char lineChar[32];
void oled_display(void)
{	
	// Get the voltage of the LiPo battry
	float volt = max17043_volt();
	// Get the state of charge of the LiPo battry
	float soc =  max17043_soc(0x04);
	int dev_count = 10;
	if ((soc == soc_pre))
        {
			sprintf(&lineChar, "Device Count: %d",dev_count); // Add number of configured device count
			ssd1306_display_text(&dev,1, lineChar, strlen(lineChar), false);
			sprintf(&lineChar, "Dev SSID:"); // Add string for SSID
			ssd1306_display_text(&dev,2, lineChar, strlen(lineChar), false);
			sprintf(&lineChar, "WAN SSID:"); // Add string for SSID
			ssd1306_display_text(&dev,3, lineChar, strlen(lineChar), false);
			for(int i=0;i<128*2;i++) 
			{
				ssd1306_wrap_arround(&dev, SCROLL_LEFT, 2, 3, 0);
			}
            vTaskDelay(250 / portTICK_PERIOD_MS);
        }
        else
        {
			// Display the LiPo information on the oled display
			if (soc <= 25.00)
			{
				ssd1306_bitmaps(&dev, 112, 0, Batt_Empty, 16, 8, false);
			}
			else if (soc <= 50.00)
			{
				ssd1306_bitmaps(&dev, 112, 0, Batt_Low, 16, 8, false);
			}

			else if (soc <= 75.00)
			{
				ssd1306_bitmaps(&dev, 112, 0, Batt_High, 16, 8, false);
			}

			else if (soc <= 100.00)
			{
				ssd1306_bitmaps(&dev, 112, 0, Batt_Full, 16, 8, false);
			}
			ESP_LOGI(BAT_TAG, "%.2f,%3.2f", soc,volt);
			sprintf(&lineChar, "%3.2fV\t\t%6.2f%%", volt, soc);
			ssd1306_display_text(&dev,0, lineChar, strlen(lineChar), false);
			soc_pre = soc;
		}

}

void oled_setup(void)
{
#if CONFIG_I2C_INTERFACE
	i2c_master_init(&dev, CONFIG_SDA_GPIO, CONFIG_SCL_GPIO, CONFIG_RESET_GPIO);
#endif 
	// CONFIG_I2C_INTERFACE
	ssd1306_init(&dev, 128, 64);
	ssd1306_clear_screen(&dev, false);
	ssd1306_contrast(&dev, 0xff);
	ssd1306_bitmaps(&dev, 0, 0, cbi_logo, 128, 32, false);
	vTaskDelay(5000 / portTICK_PERIOD_MS);
	ssd1306_clear_screen(&dev, false);
}   